<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Secure Biometric Tracking</title>
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css">
    <style>
        /* Authentication Modal Styles */
        .auth-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0,0,0,0.9);
            z-index: 10000;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .auth-box {
            background: #0a1420;
            padding: 2rem;
            border-radius: 16px;
            width: 320px;
            text-align: center;
            border: 1px solid #1a2a3a;
        }
        
        .bio-btn {
            background: linear-gradient(135deg, #00ff88 0%, #00ccff 100%);
            color: #0a0a0a;
            padding: 12px 24px;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            margin: 10px;
            transition: opacity 0.3s;
        }

        /* Main Interface Styles (hidden initially) */
        .main-interface { display: none; }
    </style>
</head>
<body>
    <!-- Authentication Interface -->
    <div id="authOverlay" class="auth-overlay">
        <div class="auth-box">
            <h2 style="color: #00ff88; margin-bottom: 1.5rem;">Secure Authentication</h2>
            <button id="bioAuthBtn" class="bio-btn" onclick="handleBiometricAuth()">
                ðŸ”’ Biometric Login
            </button>
            <div id="passwordSection" style="margin-top: 1.5rem;">
                <input type="password" id="passwordInput" placeholder="Enter Backup Code" 
                       style="background: #1a2a3a; color: white; border: 1px solid #2a3a4a; 
                              padding: 10px; border-radius: 8px; width: 100%;">
                <button class="bio-btn" onclick="handlePasswordAuth()" 
                        style="margin-top: 1rem; width: 100%;">
                    ðŸ”‘ Use Backup Code
                </button>
            </div>
        </div>
    </div>

    <!-- Main Tracking Interface -->
    <div class="main-interface">
        <!-- Original status panel and map elements here -->
    </div>

    <script>
        // Security Configuration
        const MAX_ATTEMPTS = 3;
        let authAttempts = 0;
        let registeredCredential = null;

        // WebAuthn Registration
        async function registerBiometric() {
            if (!window.isSecureContext) {
                alert('Biometric authentication requires HTTPS');
                return false;
            }

            try {
                const challenge = crypto.getRandomValues(new Uint8Array(32));
                const userId = crypto.getRandomValues(new Uint8Array(16));

                const publicKey = {
                    challenge: challenge,
                    rp: {
                        name: "Secure Tracking",
                        id: window.location.hostname
                    },
                    user: {
                        id: userId,
                        name: "secure_user",
                        displayName: "Secure User"
                    },
                    pubKeyCredParams: [
                        { type: "public-key", alg: -7 },  // ES256
                        { type: "public-key", alg: -257 } // RS256
                    ],
                    authenticatorSelection: {
                        userVerification: "required",
                        residentKey: "required"
                    },
                    timeout: 60000
                };

                const credential = await navigator.credentials.create({ publicKey });
                localStorage.setItem('credentialId', credential.id);
                return true;
            } catch (error) {
                console.error('Registration Error:', error);
                alert(`Biometric setup failed: ${error.message}`);
                return false;
            }
        }

        // WebAuthn Authentication
        async function authenticateBiometric() {
            if (!window.isSecureContext) return false;

            const credentialId = localStorage.getItem('credentialId');
            if (!credentialId) return false;

            try {
                const challenge = crypto.getRandomValues(new Uint8Array(32));
                
                const publicKey = {
                    challenge: challenge,
                    allowCredentials: [{
                        type: "public-key",
                        id: Uint8Array.from(credentialId, c => c.charCodeAt(0)),
                        transports: ["internal"]
                    }],
                    userVerification: "required",
                    timeout: 60000
                };

                const assertion = await navigator.credentials.get({ publicKey });
                return !!assertion;
            } catch (error) {
                console.error('Authentication Error:', error);
                return false;
            }
        }

        // Authentication Handlers
        async function handleBiometricAuth() {
            if (!await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()) {
                alert("Biometric auth not available");
                return;
            }

            if (!localStorage.getItem('credentialId')) {
                if (await registerBiometric()) showMainInterface();
            } else {
                if (await authenticateBiometric()) showMainInterface();
                else alert("Biometric verification failed");
            }
        }

        // Backup Password System
        function handlePasswordAuth() {
            const input = document.getElementById('passwordInput').value;
            const storedCode = localStorage.getItem('backupCode');

            if (!storedCode) {
                const newCode = crypto.getRandomValues(new Uint32Array(4)).join('-');
                localStorage.setItem('backupCode', newCode);
                alert(`New backup code generated: ${newCode}`);
                return;
            }

            if (input === storedCode) {
                showMainInterface();
            } else {
                if (++authAttempts >= MAX_ATTEMPTS) {
                    alert("Maximum attempts reached - system locked");
                    window.location.reload();
                }
                alert(`Invalid code. Attempts left: ${MAX_ATTEMPTS - authAttempts}`);
            }
        }

        // Interface Control
        function showMainInterface() {
            document.getElementById('authOverlay').style.display = 'none';
            document.querySelector('.main-interface').style.display = 'block';
            initializeTracking();
        }

        // Initialize security system
        (async function init() {
            if (!window.isSecureContext) {
                alert('System requires secure connection (HTTPS)');
                return;
            }
            
            if (!localStorage.getItem('backupCode')) {
                const backupCode = crypto.getRandomValues(new Uint32Array(4)).join('-');
                localStorage.setItem('backupCode', backupCode);
            }
            
            if (await PublicKeyCredential.isUserVerifyingPlatformAuthenticatorAvailable()) {
                document.getElementById('bioAuthBtn').disabled = false;
            }
        })();
    </script>
    
    <!-- Original map and status panel code here -->
</body>
</html>
